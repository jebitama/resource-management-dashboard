// ==========================================================================
// Prisma Schema â€” Resource Management Dashboard
// ==========================================================================
// Defines the database schema for the enterprise resource management system.
// Uses SQLite for local development; production would use PostgreSQL.
//
// To initialize:
//   npx prisma generate
//   npx prisma db push
//   npx prisma db seed
// ==========================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Authentication & RBAC ----------

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  role      String   @default("USER") // USER | ADMIN | SUPERADMIN
  status    String   @default("ACTIVE") // ACTIVE | INACTIVE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  requests  AccessRequest[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model AccessRequest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource  String
  reason    String?
  status    String   @default("PENDING") // PENDING | APPROVED | REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("access_requests")
}

// ---------- Core Entities ----------

model Resource {
  id                 String       @id @default(cuid())
  name               String
  type               String       // COMPUTE | STORAGE | NETWORK | DATABASE | CDN | CONTAINER
  status             String       @default("ACTIVE") // ACTIVE | IDLE | OVERLOADED | MAINTENANCE | DECOMMISSIONED
  region             String
  provider           String       // AWS | GCP | Azure | On-Premise
  cpuUtilization     Float        @default(0)
  memoryUtilization  Float        @default(0)
  costPerHour        Float        @default(0)
  department         String
  lastHealthCheck    DateTime     @default(now())
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  allocations        Allocation[]
  tags               ResourceTag[]

  @@index([status])
  @@index([department])
  @@index([provider])
  @@map("resources")
}

model TeamMember {
  id                String       @id @default(cuid())
  name              String
  email             String       @unique
  role              String
  department        String
  avatar            String       @default("")
  currentAllocation Float        @default(0)
  isActive          Boolean      @default(true)
  joinedAt          DateTime     @default(now())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  allocations       Allocation[]
  ledProjects       Project[]    @relation("ProjectLead")
  skills            Skill[]

  @@index([department])
  @@index([isActive])
  @@map("team_members")
}

model Project {
  id            String       @id @default(cuid())
  name          String
  code          String       @unique
  priority      String       // CRITICAL | HIGH | MEDIUM | LOW
  status        String       @default("PLANNING") // PLANNING | IN_PROGRESS | ON_HOLD | COMPLETED | CANCELLED
  department    String
  leadId        String
  lead          TeamMember   @relation("ProjectLead", fields: [leadId], references: [id])
  startDate     DateTime     @default(now())
  endDate       DateTime?
  budget        Float        @default(0)
  spent         Float        @default(0)
  progress      Int          @default(0)
  resourceCount Int          @default(0)
  teamSize      Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  allocations   Allocation[]

  @@index([status])
  @@index([priority])
  @@map("projects")
}

model Allocation {
  id           String      @id @default(cuid())
  resourceId   String
  resource     Resource    @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  teamMemberId String
  teamMember   TeamMember  @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  percentage   Float
  startDate    DateTime    @default(now())
  endDate      DateTime?
  status       String      @default("ACTIVE") // ACTIVE | PENDING | EXPIRED
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([status])
  @@map("allocations")
}

// ---------- Supporting Entities ----------

model ResourceTag {
  id         String   @id @default(cuid())
  name       String
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([name, resourceId])
  @@map("resource_tags")
}

model Skill {
  id           String     @id @default(cuid())
  name         String
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([name, teamMemberId])
  @@map("skills")
}

// ---------- Audit Log ----------

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE | UPDATE | DELETE
  entity     String   // Resource | TeamMember | Project | Allocation
  entityId   String
  changes    String   // JSON string of field changes
  performedBy String   @default("system")
  createdAt  DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
